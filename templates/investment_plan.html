<!DOCTYPE html>
<html>
<head>
    <title>Investment Plan</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f9fb;
            margin: 0;
        }

        .container {
            max-width: 700px;
            margin: 60px auto 0 auto;
            padding: 40px;
            text-align: center;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2e7d32;
            margin-bottom: 30px;
        }

        input[type="number"], select {
            padding: 12px;
            width: 250px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 20px;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 16px;
        }

        .checkbox-list {
            display: none;
            text-align: left;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .checkbox-list label {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .message {
            font-size: 16px;
            color: green;
            margin-bottom: 20px;
        }
        .analysis {
            background-color: #f0f4f9;
            border-left: 5px solid #2e7d32;
            padding: 20px;
            margin: 30px auto;
            max-width: 700px;
            border-radius: 8px;
            text-align: left;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .analysis h2 {
            color: #2e7d32;
            margin-bottom: 16px;
        }

        .analysis-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 15px;
            color: #333;
        }

        .table-container {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            overflow-x: auto;
        }

        .styled-table {
            border-collapse: collapse;
            margin: 0 auto;
            font-size: 14px;
            min-width: 1000px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
            text-align: center;
            background-color: #fff;
        }

        .styled-table thead tr {
            background-color: #007BFF;
            color: #ffffff;
            text-align: center;
            font-weight: bold;
        }

        .styled-table th,
        .styled-table td {
            padding: 10px 15px;
            border: 1px solid #dddddd;
            max-width: 250px;
            word-wrap: break-word;
        }

        .styled-table tbody tr:nth-child(even) {
            background-color: #f3f3f3;
        }

        .styled-table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .analysis-content {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            white-space: pre-line; /* ‚úÖ This preserves line breaks and reduces extra gaps */
            padding: 16px;
            background-color: #f9f9f9;
            border-radius: 8px;
            color: #333;
            font-size: 15px;
        }

        #pdf-section {
            display: block !important;
            position: relative !important;
            opacity: 1 !important;
            visibility: visible !important;
            overflow-x: auto; 
        }

        #pdf-section {
            display: block !important;
            opacity: 1 !important;
            height: auto !important;
            visibility: visible !important;
        }


        #pdf-section.combined-container {
            max-width: 1000px;
            margin: 30px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        #pdf-section .styled-table {
            width: 100%;
            margin-bottom: 30px;
            table-layout: auto;
            word-break: break-word;
            white-space: normal;
        }

        .analysis-content-section {
            text-align: left;
        }

        .download-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .download-buttons button {
            background-color: #007bff;
            color: white;
            font-size: 16px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .download-buttons button:hover {
            background-color: #0056b3;
        }

        #download-buttons {
            display: none;
        }

        .cost-note {
            font-size: 12px;
            color: #555;
            text-align: center;
            margin-top: 10px;
        }


    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</head>
<body>


<div class="container">
    <h1>üí∞ Create Your Investment Plan</h1>

    <!-- {% if message %}
        <div class="message">{{ message }}</div>
    {% endif %} -->

    <form action="/investment-plan" method="post">
        <input type="number" name="amount" placeholder="Enter amount in ‚Çπ" required min="1000" step="100"><br>

        <select name="category" id="category" onchange="toggleFundList()" required>
            <option value="" disabled selected>Select Fund Category</option>
            <option value="large Cap">Large Cap</option>
            <option value="mid Cap">Mid Cap</option>
            <option value="small Cap">Small Cap</option>
            <option value="Infrastructure">Infrastructure</option>
        </select><br>

        <!-- Large Cap -->
        <div id="large Cap" class="checkbox-list">
            <label><input type="checkbox" class="select-all" data-target="large Cap" /> Select All</label>
            <label><input type="checkbox" name="funds" value="Bandhan Large Cap Dir"> Bandhan Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Canara Robeco Large Cap Dir"> Canara Robeco Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="DSP Large Cap Dir"> DSP Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Franklin India Large Cap Dir"> Franklin India Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="HDFC Large Cap Dir"> HDFC Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="ICICI Pru Bharat 22 FOF Dir"> ICICI Pru Bharat 22 FOF Dir</label>
            <label><input type="checkbox" name="funds" value="ICICI Pru Large Cap Dir"> ICICI Pru Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Invesco India Largecap Dir"> Invesco India Largecap Dir</label>
            <label><input type="checkbox" name="funds" value="Mirae Asset Large Cap Dir"> Mirae Asset Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Motilal Oswal Large Cap Dir"> Motilal Oswal Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Nippon India Large Cap Dir"> Nippon India Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Nippon India Nifty Next 50 Junior BeES FoF Dir"> Nippon India Nifty Next 50 Junior BeES FoF Dir</label>
            <label><input type="checkbox" name="funds" value="Quant Large Cap Dir"> Quant Large Cap Dir</label>
            <label><input type="checkbox" name="funds" value="WhiteOak Capital Large Cap Dir"> WhiteOak Capital Large Cap Dir</label>

        </div>

        <!-- Mid Cap -->
        <div id="mid Cap" class="checkbox-list">
            <label><input type="checkbox" class="select-all" data-target="mid Cap" /> Select All</label>
            <label><input type="checkbox" name="funds" value="Canara Robeco Mid Cap Dir"> Canara Robeco Mid Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Edelweiss Mid Cap Dir"> Edelweiss Mid Cap Dir</label>
            <label><input type="checkbox" name="funds" value="HDFC Mid Cap Dir"> HDFC Mid Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Helios Mid Cap Dir"> Helios Mid Cap Dir</label>
            <label><input type="checkbox" name="funds" value="ICICI Pru Midcap Dir"> ICICI Pru Midcap Dir</label>
            <label><input type="checkbox" name="funds" value="Invesco India Mid cap Dir"> Invesco India Mid cap Dir</label>
            <label><input type="checkbox" name="funds" value="Motilal Oswal Midcap Dir"> Motilal Oswal Midcap Dir</label>
            <label><input type="checkbox" name="funds" value="Nippon India Growth Mid Cap Dir"> Nippon India Growth Mid Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Quant Mid Cap Dir"> Quant Mid Cap Dir</label>
            <label><input type="checkbox" name="funds" value="WhiteOak Capital Mid Cap Fund Dir"> WhiteOak Capital Mid Cap Fund Dir</label>

        </div>

        <!-- Small Cap -->
        <div id="small Cap" class="checkbox-list">
            <label><input type="checkbox" class="select-all" data-target="small Cap" /> Select All</label>
            <label><input type="checkbox" name="funds" value="Axis Small Cap Dir"> Axis Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Bandhan Small Cap Dir"> Bandhan Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Bank of India Small Cap Dir"> Bank of India Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="DSP Small Cap Dir"> DSP Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Edelweiss Small Cap Dir"> Edelweiss Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Franklin India Small Cap Dir"> Franklin India Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="HDFC Small Cap Dir"> HDFC Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="HSBC Small Cap Eqt Dir"> HSBC Small Cap Eqt Dir</label>
            <label><input type="checkbox" name="funds" value="Invesco India Smallcap Dir"> Invesco India Smallcap Dir</label>
            <label><input type="checkbox" name="funds" value="Motilal Oswal Small Cap Dir"> Motilal Oswal Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Nippon India Small Cap Dir"> Nippon India Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="PGIM India Small Cap Dir"> PGIM India Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="Quant Small Cap Dir"> Quant Small Cap Dir</label>
            <label><input type="checkbox" name="funds" value="SBI Small Cap Dir"> SBI Small Cap Dir</label>

        </div>

        <!-- Infrastructure -->
        <div id="Infrastructure" class="checkbox-list">
            <label><input type="checkbox" class="select-all" data-target="Infrastructure" /> Select All</label>
            <label><input type="checkbox" name="funds" value="Bandhan Infrastructure Dir"> Bandhan Infrastructure Dir</label>
            <label><input type="checkbox" name="funds" value="Bank of India Manufacturing & Infra Dir"> Bank of India Manufacturing & Infra Dir</label>
            <label><input type="checkbox" name="funds" value="Canara Robeco Infrastructure Dir"> Canara Robeco Infrastructure Dir</label>
            <label><input type="checkbox" name="funds" value="DSP India T.I.G.E.R. Reg"> DSP India T.I.G.E.R. Reg</label>
            <label><input type="checkbox" name="funds" value="Franklin Build India Dir"> Franklin Build India Dir</label>
            <label><input type="checkbox" name="funds" value="HDFC Infrastructure Dir"> HDFC Infrastructure Dir</label>
            <label><input type="checkbox" name="funds" value="ICICI Pru Infrastructure Dir"> ICICI Pru Infrastructure Dir</label>
            <label><input type="checkbox" name="funds" value="Invesco India Infrastructure Dir"> Invesco India Infrastructure Dir</label>
            <label><input type="checkbox" name="funds" value="LIC MF Infrastructure Dir"> LIC MF Infrastructure Dir</label>
            <label><input type="checkbox" name="funds" value="Nippon India Power & Infra Dir"> Nippon India Power & Infra Dir</label>
            <label><input type="checkbox" name="funds" value="Quant Infrastructure Dir"> Quant Infrastructure Dir</label>

        </div>

        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
            <button type="submit" name="action" value="quick" style="width: 160px;">‚ö° Quick View</button>
            <button type="submit" name="action" value="deep" style="width: 160px;">üîç Deep Dive</button>
        </div>


        <div class="cost-note">
            Quick View ~ ‚Çπ2 | Deep Dive ~ ‚Çπ8
        </div>

    </form>
</div>


{% if funds_looking_for %}
    <div class="analysis">
        <h2>üîç Funds You're Targeting</h2>
        <ul>
            {% for fund in funds_looking_for %}
                <li>{{ fund }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

{% if funds_invested %}
    <div class="analysis">
        <h2>üìÅ Funds You're Already Invested In</h2>
        <ul>
            {% for fund in funds_invested %}
                <li>{{ fund }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div id="report-table" class="table-container">
    {% if table_data is defined and table_data is not none and not table_data.empty %}
        <table class="styled-table">
            <thead>
                <tr>
                    {% for col in table_data.columns %}
                        <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in table_data.values %}
                    <tr>
                        {% for cell in row %}
                            <td>{{ cell }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>

{% if analysis %}
    <div id="pdf-section" class="combined-container">
        <div class="analysis-content-section">
            <h2>üìä LLM Investment Analysis</h2>
            <div class="analysis-content">
                {{ analysis | safe }}
            </div>
        </div>
    </div>

    <div id="download-buttons" class="download-buttons">
        <button id="download-pdf" class="download-btn" onclick="downloadPDF()">Download PDF</button>
        <button id="download-csv" class="download-btn">Download Table</button>
    </div>
{% endif %}





<script>

    let selectedCategory = '';

    function toggleFundList() {
        const selectedCategory = document.getElementById("category").value;
        document.querySelectorAll(".checkbox-list").forEach(el => el.style.display = "none");
        if (selectedCategory) {
            document.getElementById(selectedCategory).style.display = "block";
        }
        // Uncheck all checkboxes on category change
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function getSelectedCategory() {
        const categorySelect = document.getElementById("category");
        return categorySelect.value.toLowerCase().replace(/\s+/g, '_');
    }


    function getFormattedDateTime() {
        const now = new Date();
        return now.toLocaleString('en-GB', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        }).replace(/[\/,: ]+/g, '-');
    }


    document.getElementById("download-csv").addEventListener("click", function () {
      const table = document.querySelector("table");
      if (!table) return;

      let csv = "";
      for (const row of table.rows) {
        let rowData = [];
        for (const cell of row.cells) {
          rowData.push(cell.innerText.replace(/,/g, ""));
        }
        csv += rowData.join(",") + "\n";
      }
      const category = getSelectedCategory();
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
    //   a.download = `table_data_${getFormattedDateTime()}.csv`;
      a.download = `${category}_table_${getFormattedDateTime()}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    function downloadPDF() {
        const element = document.getElementById('pdf-section');
        // Get selected category value
        const selectedCategory = document.getElementById("category").value;


        if (!element || element.innerText.trim() === '') {
            alert("Report content is not ready.");
            return;
        }

         // Get the selected category
        const categorySelect = document.getElementById("category");
        const category = categorySelect ? categorySelect.value.toLowerCase().replace(/\s+/g, '_') : 'report';

        // Clone the content to prevent layout shifts
        const clone = element.cloneNode(true);

        // Optional: move to body temporarily for rendering
        const printArea = document.createElement('div');
        printArea.style.position = 'absolute';
        printArea.style.top = '-9999px';
        printArea.appendChild(clone);
        document.body.appendChild(printArea);

        const opt = {
            margin:       0.3,
            // filename:     `report_${getFormattedDateTime()}.pdf`,
            filename:     `${selectedCategory}_report_${getFormattedDateTime()}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                windowWidth: document.documentElement.offsetWidth
            },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        setTimeout(() => {
            html2pdf().set(opt).from(clone).save().then(() => {
                document.body.removeChild(printArea);
            });
        }, 300);
    }


    window.onload = function () {
        const hasTable = document.querySelector('.styled-table');
        const hasAnalysis = document.querySelector('.analysis-content');

        if (hasTable || hasAnalysis) {
            document.getElementById('download-buttons').style.display = 'flex';
        }
    };




    document.addEventListener('change', function (e) {
        if (e.target.type === 'checkbox') {
            const visibleCheckboxes = Array.from(document.querySelectorAll('.checkbox-list'))
                .filter(div => div.style.display !== 'none')
                .flatMap(div => Array.from(div.querySelectorAll('input[type="checkbox"]')));

            const checked = visibleCheckboxes.filter(cb => cb.checked);
        }

        document.querySelectorAll('.select-all').forEach(selectAllCheckbox => {
            selectAllCheckbox.addEventListener('change', function() {
                const targetId = this.getAttribute('data-target');
                const escapedId = CSS.escape(targetId);
                const checkboxes = document.querySelectorAll(`#${escapedId} input[type="checkbox"]:not(.select-all)`);
                checkboxes.forEach(cb => cb.checked = this.checked);
            });
        });
    });



</script>
</body>
</html>
